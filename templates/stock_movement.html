{% extends 'base.html' %}

{% block page_title %}รับเข้า / จ่ายออกสต็อก{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
        <h4 class="mb-0">รับเข้า / จ่ายออกสต็อก</h4>
        <div>
            <a href="{{ url_for('daily_stock_report') }}" class="btn btn-outline-info btn-sm"><i class="fas fa-chart-bar me-2"></i>รายงานประจำวัน</a>
            <a href="{{ url_for('summary_stock_report') }}" class="btn btn-outline-info btn-sm"><i class="fas fa-calendar-alt me-2"></i>สรุปรายงานรายช่วง</a>
        </div>
    </div>
    <div class="card-body">
        <ul class="nav nav-tabs" id="stockMovementTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if active_tab == 'tire_movements' or not active_tab %}active{% endif %}" id="tire-tab" data-bs-toggle="tab" data-bs-target="#tire-pane" type="button" role="tab" aria-controls="tire-pane" aria-selected="true">
                    <i class="fas fa-tire me-2"></i>สต็อกยาง
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if active_tab == 'wheel_movements' %}active{% endif %}" id="wheel-tab" data-bs-toggle="tab" data-bs-target="#wheel-pane" type="button" role="tab" aria-controls="wheel-pane" aria-selected="false">
                    <i class="fas fa-compact-disc me-2"></i>สต็อกแม็ก
                </button>
            </li>
        </ul>

        <div class="tab-content pt-3">
            <div class="tab-pane fade {% if active_tab == 'tire_movements' or not active_tab %}show active{% endif %}" id="tire-pane" role="tabpanel" aria-labelledby="tire-tab">
                <div class="border p-3 rounded mb-4">
                    <h5>ทำรายการสต็อกยาง</h5>
                    <form action="{{ url_for('stock_movement') }}" method="post" enctype="multipart/form-data">
                        <input type="hidden" name="submit_type" value="tire_movement">
                        <div class="row g-3">
                            <div class="col-lg-6">
                                <label for="tire_id" class="form-label">เลือกยาง*</label>
                                <select class="form-select" id="tire_id" name="tire_id" required>
                                    <option value="">-- ค้นหาและเลือกยาง --</option>
                                    {% for tire in tires %}<option value="{{ tire.id }}">{{ tire.brand }} {{ tire.model }} {{ tire.size }} (คงเหลือ: {{ tire.quantity }})</option>{% endfor %}
                                </select>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <label for="tire_movement_type" class="form-label">ประเภท*</label>
                                <select class="form-select" id="tire_movement_type" name="type" required onchange="toggleMovementTypeDetails('tire')">
                                    <option value="">-- เลือกประเภท --</option><option value="IN">รับเข้า</option><option value="OUT">จ่ายออก</option><option value="RETURN">รับคืน/ตีคืน</option>
                                </select>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <label for="tire_quantity" class="form-label">จำนวน (เส้น)*</label>
                                <input type="number" class="form-control" id="tire_quantity" name="quantity" min="1" required>
                            </div>

                            <div class="col-12" id="tire_channel_section" style="display: none;"><label for="tire_channel_id" class="form-label">ช่องทาง*</label><select class="form-select" id="tire_channel_id" name="channel_id" required onchange="toggleChannelDetails('tire')"><option value="">-- เลือกช่องทาง --</option>{% for ch in sales_channels %}<option value="{{ ch.id }}">{{ ch.name }}</option>{% endfor %}</select></div>
                            <div class="col-12" id="tire_online_platform_section" style="display: none;"><label for="tire_online_platform_id" class="form-label">แพลตฟอร์มออนไลน์</label><select class="form-select select2-enable" id="tire_online_platform_id" name="online_platform_id"><option value="">-- เลือก --</option>{% for p in online_platforms %}<option value="{{ p.id }}">{{ p.name }}</option>{% endfor %}</select></div>
                            <div class="col-12" id="tire_wholesale_customer_section" style="display: none;"><label for="tire_wholesale_customer_id" class="form-label">ลูกค้าค้าส่ง</label><select class="form-select select2-enable" id="tire_wholesale_customer_id" name="wholesale_customer_id"><option value="">-- เลือก --</option>{% for c in wholesale_customers %}<option value="{{ c.id }}">{{ c.name }}</option>{% endfor %}</select></div>
                            <div class="col-12" id="tire_return_customer_type_section" style="display: none;"><label for="tire_return_customer_type" class="form-label">คืนจาก</label><select class="form-select select2-enable" id="tire_return_customer_type" name="return_customer_type" onchange="toggleReturnDetails('tire')"><option value="">-- เลือก --</option><option value="หน้าร้านลูกค้า">ลูกค้าทั่วไป</option><option value="หน้าร้านร้านยาง">ร้านยาง</option><option value="ออนไลน์">ออนไลน์</option></select></div>
                            <div class="col-12" id="tire_return_wholesale_customer_section" style="display: none;"><label for="tire_return_wholesale_customer_id" class="form-label">ชื่อร้านยางที่คืน</label><select class="form-select select2-enable" id="tire_return_wholesale_customer_id" name="return_wholesale_customer_id"><option value="">-- เลือก --</option>{% for c in wholesale_customers %}<option value="{{ c.id }}">{{ c.name }}</option>{% endfor %}</select></div>
                            <div class="col-12" id="tire_return_online_platform_section" style="display: none;"><label for="tire_return_online_platform_id" class="form-label">แพลตฟอร์มที่คืน</label><select class="form-select select2-enable" id="tire_return_online_platform_id" name="return_online_platform_id"><option value="">-- เลือก --</option>{% for p in online_platforms %}<option value="{{ p.id }}">{{ p.name }}</option>{% endfor %}</select></div>

                            <div class="col-md-6"><label for="tire_notes" class="form-label">หมายเหตุ</label><input type="text" class="form-control" id="tire_notes" name="notes"></div>
                            <div class="col-md-6"><label for="tire_bill_image" class="form-label">รูปบิล</label><input type="file" class="form-control" id="tire_bill_image" name="bill_image" accept="image/*"></div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">บันทึก</button>
                    </form>
                </div>
                <h5>ประวัติล่าสุด (ยาง)</h5>
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm align-middle">
                        <thead class="table-light"><tr><th>เวลา</th><th>ข้อมูล</th><th>ประเภท</th><th>จำนวน</th><th>คงเหลือ</th><th>ช่องทาง/ลูกค้า</th><th>พนักงาน</th><th>หมายเหตุ</th><th class="text-center">หลักฐาน</th>{% if current_user.is_admin() %}<th class="text-center">จัดการ</th>{% endif %}</tr></thead>
                        <tbody>
                            {% for m in tire_movements %}
                            <tr><td>{{ m.timestamp.strftime('%d/%m %H:%M') }}</td><td>{{ m.brand }} {{ m.model }} {{ m.size }}</td><td>{% if m.type=='IN' %}<span class="badge text-bg-success">รับเข้า</span>{% elif m.type=='OUT' %}<span class="badge text-bg-danger">จ่ายออก</span>{% elif m.type=='RETURN' %}<span class="badge text-bg-info">รับคืน</span>{% endif %}</td><td>{{ m.quantity_change }}</td><td>{{ m.remaining_quantity }}</td><td>{% if m.channel_name=='ออนไลน์'%}{{m.online_platform_name|default('-')}}{% elif m.channel_name=='ค้าส่ง'%}{{m.wholesale_customer_name|default('-')}}{% elif m.type=='RETURN' and m.return_customer_type%}{{m.return_customer_type}}{% if m.return_customer_type=='ออนไลน์'%}({{m.online_platform_name|default('-')}}){% elif m.return_customer_type=='หน้าร้านร้านยาง'%}({{m.wholesale_customer_name|default('-')}}){% endif %}{% else %}{{m.channel_name|default('-')}}{% endif %}</td><td>{{ m.user_username|default('-') }}</td><td>{{ m.notes|default('-')}}</td><td class="text-center">{% if m.image_filename %}<a href="{{ m.image_filename }}" target="_blank"><i class="fas fa-image"></i></a>{% else %}-{% endif %}</td>{% if current_user.is_admin() %}<td class="text-center"><div class="d-flex gap-1 justify-content-center"><a href="{{url_for('edit_tire_movement', movement_id=m.id)}}" class="btn btn-warning btn-sm" title="แก้ไข"><i class="fas fa-edit"></i></a><form action="{{url_for('delete_tire_movement_action', movement_id=m.id)}}" method="POST" class="d-inline" onsubmit="return confirm('ยืนยันการลบ?');"><button type="submit" class="btn btn-danger btn-sm" title="ลบ"><i class="fas fa-trash-alt"></i></button></form></div></td>{% endif %}</tr>
                            {% else %}<tr><td colspan="11" class="text-center text-muted">ยังไม่มีประวัติ</td></tr>{% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade {% if active_tab == 'wheel_movements' %}show active{% endif %}" id="wheel-pane" role="tabpanel" aria-labelledby="wheel-tab">
                <div class="border p-3 rounded mb-4">
                    <h5>ทำรายการสต็อกแม็ก</h5>
                    <form action="{{ url_for('stock_movement') }}" method="post" enctype="multipart/form-data">
                        <input type="hidden" name="submit_type" value="wheel_movement">
                        <div class="row g-3">
                            <div class="col-lg-6"><label for="wheel_id" class="form-label">เลือกแม็ก*</label><select class="form-select" id="wheel_id" name="wheel_id" required><option value="">-- ค้นหาและเลือกแม็ก --</option>{% for w in wheels %}<option value="{{ w.id }}">{{ w.brand }} {{ w.model }} {{ "%.1f"|format(w.diameter) }} (คงเหลือ: {{ w.quantity }})</option>{% endfor %}</select></div>
                            <div class="col-lg-3 col-md-6"><label for="wheel_movement_type" class="form-label">ประเภท*</label><select class="form-select" id="wheel_movement_type" name="type" required onchange="toggleMovementTypeDetails('wheel')"><option value="">-- เลือก --</option><option value="IN">รับเข้า</option><option value="OUT">จ่ายออก</option><option value="RETURN">รับคืน</option></select></div>
                            <div class="col-lg-3 col-md-6"><label for="wheel_quantity" class="form-label">จำนวน (วง)*</label><input type="number" class="form-control" id="wheel_quantity" name="quantity" min="1" required></div>
                            
                            <div class="col-12" id="wheel_channel_section" style="display: none;"><label for="wheel_channel_id" class="form-label">ช่องทาง*</label><select class="form-select" id="wheel_channel_id" name="channel_id" required onchange="toggleChannelDetails('wheel')"><option value="">-- เลือก --</option>{% for ch in sales_channels %}<option value="{{ ch.id }}">{{ ch.name }}</option>{% endfor %}</select></div>
                            <div class="col-12" id="wheel_online_platform_section" style="display: none;"><label for="wheel_online_platform_id" class="form-label">แพลตฟอร์ม</label><select class="form-select select2-enable" id="wheel_online_platform_id" name="online_platform_id"><option value="">-- เลือก --</option>{% for p in online_platforms %}<option value="{{ p.id }}">{{ p.name }}</option>{% endfor %}</select></div>
                            <div class="col-12" id="wheel_wholesale_customer_section" style="display: none;"><label for="wheel_wholesale_customer_id" class="form-label">ลูกค้าค้าส่ง</label><select class="form-select select2-enable" id="wheel_wholesale_customer_id" name="wholesale_customer_id"><option value="">-- เลือก --</option>{% for c in wholesale_customers %}<option value="{{ c.id }}">{{ c.name }}</option>{% endfor %}</select></div>
                            <div class="col-12" id="wheel_return_customer_type_section" style="display: none;"><label for="wheel_return_customer_type" class="form-label">คืนจาก</label><select class="form-select select2-enable" id="wheel_return_customer_type" name="return_customer_type" onchange="toggleReturnDetails('wheel')"><option value="">-- เลือก --</option><option value="หน้าร้านลูกค้า">ลูกค้าทั่วไป</option><option value="หน้าร้านร้านยาง">ร้านยาง</option><option value="ออนไลน์">ออนไลน์</option></select></div>
                            <div class="col-12" id="wheel_return_wholesale_customer_section" style="display: none;"><label for="wheel_return_wholesale_customer_id" class="form-label">ร้านยางที่คืน</label><select class="form-select select2-enable" id="wheel_return_wholesale_customer_id" name="return_wholesale_customer_id"><option value="">-- เลือก --</option>{% for c in wholesale_customers %}<option value="{{ c.id }}">{{ c.name }}</option>{% endfor %}</select></div>
                            <div class="col-12" id="wheel_return_online_platform_section" style="display: none;"><label for="wheel_return_online_platform_id" class="form-label">แพลตฟอร์มที่คืน</label><select class="form-select select2-enable" id="wheel_return_online_platform_id" name="return_online_platform_id"><option value="">-- เลือก --</option>{% for p in online_platforms %}<option value="{{ p.id }}">{{ p.name }}</option>{% endfor %}</select></div>

                            <div class="col-md-6"><label for="wheel_notes" class="form-label">หมายเหตุ</label><input type="text" class="form-control" id="wheel_notes" name="notes"></div>
                            <div class="col-md-6"><label for="wheel_bill_image" class="form-label">รูปบิล</label><input type="file" class="form-control" id="wheel_bill_image" name="bill_image" accept="image/*"></div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">บันทึก</button>
                    </form>
                </div>
                <h5>ประวัติล่าสุด (แม็ก)</h5>
                 <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm align-middle">
                        <thead class="table-light"><tr><th>เวลา</th><th>ข้อมูล</th><th>ประเภท</th><th>จำนวน</th><th>คงเหลือ</th><th>ช่องทาง/ลูกค้า</th><th>พนักงาน</th><th>หมายเหตุ</th><th class="text-center">หลักฐาน</th>{% if current_user.is_admin() %}<th class="text-center">จัดการ</th>{% endif %}</tr></thead>
                        <tbody>
                            {% for m in wheel_movements %}
                            <tr><td>{{ m.timestamp.strftime('%d/%m %H:%M') }}</td><td>{{ m.brand }} {{ m.model }} {{ "%.1f"|format(m.diameter) }}</td><td>{% if m.type=='IN' %}<span class="badge text-bg-success">รับเข้า</span>{% elif m.type=='OUT' %}<span class="badge text-bg-danger">จ่ายออก</span>{% elif m.type=='RETURN' %}<span class="badge text-bg-info">รับคืน</span>{% endif %}</td><td>{{ m.quantity_change }}</td><td>{{ m.remaining_quantity }}</td><td>{% if m.channel_name=='ออนไลน์'%}{{m.online_platform_name|default('-')}}{% elif m.channel_name=='ค้าส่ง'%}{{m.wholesale_customer_name|default('-')}}{% elif m.type=='RETURN' and m.return_customer_type%}{{m.return_customer_type}}{% if m.return_customer_type=='ออนไลน์'%}({{m.online_platform_name|default('-')}}){% elif m.return_customer_type=='หน้าร้านร้านยาง'%}({{m.wholesale_customer_name|default('-')}}){% endif %}{% else %}{{m.channel_name|default('-')}}{% endif %}</td><td>{{ m.user_username|default('-') }}</td><td>{{ m.notes|default('-')}}</td><td class="text-center">{% if m.image_filename %}<a href="{{ m.image_filename }}" target="_blank"><i class="fas fa-image"></i></a>{% else %}-{% endif %}</td>{% if current_user.is_admin() %}<td class="text-center"><div class="d-flex gap-1 justify-content-center"><a href="{{url_for('edit_wheel_movement', movement_id=m.id)}}" class="btn btn-warning btn-sm" title="แก้ไข"><i class="fas fa-edit"></i></a><form action="{{url_for('delete_wheel_movement_action', movement_id=m.id)}}" method="POST" class="d-inline" onsubmit="return confirm('ยืนยันการลบ?');"><button type="submit" class="btn btn-danger btn-sm" title="ลบ"><i class="fas fa-trash-alt"></i></button></form></div></td>{% endif %}</tr>
                            {% else %}<tr><td colspan="11" class="text-center text-muted">ยังไม่มีประวัติ</td></tr>{% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- Helper Functions for Select2 ---
    function initSelect2(selector, placeholderText, allowClear = true, minimumInputLength = 0) { 
        const element = $(selector);
        if (element.length && !element.data('select2')) {
            element.select2({
                placeholder: placeholderText,
                allowClear: allowClear,
                minimumInputLength: minimumInputLength,
                width: '100%'
            });
        }
    }
    function destroySelect2(selector) {
        const element = $(selector);
        if (element.data('select2')) element.select2('destroy');
    }

    // --- Main Dynamic Form Logic ---
    function toggleMovementTypeDetails(itemType) {
        const typeSelect = document.getElementById(`${itemType}_movement_type`);
        const channelSection = document.getElementById(`${itemType}_channel_section`); // --- เพิ่มบรรทัดนี้
        const channelSelect = document.getElementById(`${itemType}_channel_id`);
        const salesChannels = JSON.parse('{{ sales_channels | tojson | safe }}');
        
        // --- ส่วนที่แก้ไข ---
        // ตรวจสอบว่ามีการเลือกประเภทหรือไม่ เพื่อแสดง/ซ่อนช่อง "ช่องทาง"
        if (typeSelect.value) {
            channelSection.style.display = 'block';
        } else {
            channelSection.style.display = 'none';
        }
        // --- จบส่วนแก้ไข ---
        
        const buyInChannelId = salesChannels.find(c => c.name === 'ซื้อเข้า')?.id;
        const returnChannelId = salesChannels.find(c => c.name === 'รับคืน')?.id;
        const outChannelsIds = ['ออนไลน์', 'ค้าส่ง', 'หน้าร้าน'].map(name => salesChannels.find(c => c.name === name)?.id).filter(id => id);

        Array.from(channelSelect.options).forEach(option => {
            if (!option.value) { option.style.display = 'block'; return; }
            const value = parseInt(option.value);
            let shouldShow = false;
            if (typeSelect.value === 'IN' && value === buyInChannelId) shouldShow = true;
            if (typeSelect.value === 'OUT' && outChannelsIds.includes(value)) shouldShow = true;
            if (typeSelect.value === 'RETURN' && value === returnChannelId) shouldShow = true;
            option.style.display = shouldShow ? 'block' : 'none';
        });

        if (typeSelect.value === 'IN') channelSelect.value = buyInChannelId || '';
        else if (typeSelect.value === 'RETURN') channelSelect.value = returnChannelId || '';
        else channelSelect.value = '';

        toggleChannelDetails(itemType);
    }

    function toggleChannelDetails(itemType) {
        const sections = ['online_platform', 'wholesale_customer', 'return_customer_type'];
        sections.forEach(sec => document.getElementById(`${itemType}_${sec}_section`).style.display = 'none');

        const channelSelect = document.getElementById(`${itemType}_channel_id`);
        const selectedChannelOption = channelSelect.options[channelSelect.selectedIndex];
        if (!selectedChannelOption) return;
        
        const selectedChannelName = selectedChannelOption.text.trim();
        if (selectedChannelName === 'ออนไลน์') document.getElementById(`${itemType}_online_platform_section`).style.display = 'block';
        else if (selectedChannelName === 'ค้าส่ง') document.getElementById(`${itemType}_wholesale_customer_section`).style.display = 'block';
        else if (selectedChannelName === 'รับคืน') {
            document.getElementById(`${itemType}_return_customer_type_section`).style.display = 'block';
            toggleReturnDetails(itemType);
        }
    }

    function toggleReturnDetails(itemType) {
        const returnSections = ['return_online_platform', 'return_wholesale_customer'];
        returnSections.forEach(sec => document.getElementById(`${itemType}_${sec}_section`).style.display = 'none');

        const returnTypeSelect = document.getElementById(`${itemType}_return_customer_type`);
        if (returnTypeSelect.value === 'ออนไลน์') document.getElementById(`${itemType}_return_online_platform_section`).style.display = 'block';
        else if (returnTypeSelect.value === 'หน้าร้านร้านยาง') document.getElementById(`${itemType}_return_wholesale_customer_section`).style.display = 'block';
    }

    // --- Main Execution ---
    document.addEventListener('DOMContentLoaded', function() {
        const stockMovementTab = document.getElementById('stockMovementTab');

        function initializeTab(tabId) {
            const itemType = tabId === 'tire-pane' ? 'tire' : 'wheel';
            const otherItemType = itemType === 'tire' ? 'wheel' : 'tire';

            initSelect2(`#${itemType}_id`, `-- ค้นหาและเลือก${itemType === 'tire' ? 'ยาง' : 'แม็ก'} --`, true, 0);
            initSelect2(`#${itemType}_online_platform_id`, '-- เลือกแพลตฟอร์ม --', true, 0);
            initSelect2(`#${itemType}_wholesale_customer_id`, '-- ค้นหาลูกค้า --', true, 0);
            initSelect2(`#${itemType}_return_customer_type`, '-- เลือกประเภทการคืน --', true, 0);
            initSelect2(`#${itemType}_return_online_platform_id`, '-- เลือกแพลตฟอร์ม --', true, 0);
            initSelect2(`#${itemType}_return_wholesale_customer_id`, '-- ค้นหาร้านยาง --', true, 0);

            destroySelect2(`#${otherItemType}_id`);
            destroySelect2(`#${otherItemType}_online_platform_id`);
            destroySelect2(`#${otherItemType}_wholesale_customer_id`);
            destroySelect2(`#${otherItemType}_return_customer_type`);
            destroySelect2(`#${otherItemType}_return_online_platform_id`);
            destroySelect2(`#${otherItemType}_return_wholesale_customer_id`);
            
            toggleMovementTypeDetails(itemType);
        }

        stockMovementTab.addEventListener('shown.bs.tab', function(event) {
            const activeTabId = event.target.getAttribute('data-bs-target').substring(1);
            initializeTab(activeTabId);

            const url = new URL(window.location);
            url.searchParams.set('tab', activeTabId.replace('-pane', '_movements'));
            window.history.pushState({}, '', url);
        });

        const initialActiveTab = document.querySelector('#stockMovementTab .nav-link.active');
        if (initialActiveTab) {
            const initialTabId = initialActiveTab.getAttribute('data-bs-target').substring(1);
            initializeTab(initialTabId);
        }
    });
</script>
{% endblock %}